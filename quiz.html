<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📚 Sue Reading Academy - Quiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .quiz-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .quiz-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .quiz-title {
            font-size: 2rem;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 10px;
        }

        .quiz-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .progress-info {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .timer {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .chapter-score {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            display: none;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            flex: 1;
        }

        .question-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .question-number {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
        }

        .chapter-badge {
            background: #f8f9fa;
            color: #495057;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .question-text {
            font-size: 1.3rem;
            line-height: 1.6;
            color: #333;
            margin-bottom: 25px;
            font-weight: 500;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }

        .option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .option:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateX(3px);
        }

        .option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea20, #764ba220);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .option-letter {
            width: 32px;
            height: 32px;
            background: #e9ecef;
            color: #495057;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .option.selected .option-letter {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .option-text {
            flex: 1;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .nav-btn.prev {
            background: #6c757d;
            color: white;
        }

        .nav-btn.next {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .nav-btn.chapter-finish {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
        }

        .nav-btn.finish {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 2%;
        }

        /* 챕터 결과 모달 */
        .chapter-result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .chapter-result-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chapter-result-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .chapter-result-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .chapter-result-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 10px;
        }

        .chapter-score {
            font-size: 2.5rem;
            font-weight: 800;
            color: #28a745;
            margin-bottom: 20px;
        }

        .questions-review {
            margin-bottom: 30px;
        }

        .question-review-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #e9ecef;
        }

        .question-review-item.correct {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .question-review-item.wrong {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .review-question {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .review-answers {
            font-size: 0.9rem;
        }

        .your-answer {
            color: #dc3545;
            font-weight: 600;
        }

        .correct-answer {
            color: #28a745;
            font-weight: 600;
        }

        .continue-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 1.1rem;
        }

        .continue-btn:hover {
            transform: translateY(-2px);
        }

        /* 최종 결과 모달 */
        .final-result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .final-result-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .final-result-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .final-result-title {
            font-size: 2rem;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 20px;
        }

        .final-score {
            font-size: 3rem;
            font-weight: 800;
            color: #28a745;
            margin-bottom: 20px;
        }

        .final-details {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .chapter-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .chapter-score-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .result-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .result-btn:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .quiz-container {
                padding: 15px;
            }
            
            .quiz-header {
                padding: 20px;
            }
            
            .question-card {
                padding: 20px;
            }
            
            .navigation {
                flex-direction: column;
                gap: 15px;
            }
            
            .progress-bar {
                order: -1;
                margin: 0 0 15px 0;
            }

            .chapter-result-content {
                padding: 25px;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <!-- 퀴즈 헤더 -->
        <div class="quiz-header">
            <div class="quiz-title" id="bookTitle">Magic Tree House Quiz</div>
            <div class="quiz-info">
                <div class="progress-info" id="progressInfo">문제 1/50</div>
                <div class="chapter-score" id="chapterScoreDisplay">Chapter 1: 0/10</div>
                <div class="timer" id="timer">30:00</div>
            </div>
        </div>

        <!-- 문제 카드 -->
        <div class="question-card">
            <div class="question-meta">
                <div class="question-number" id="questionNumber">문제 1</div>
                <div class="chapter-badge" id="chapterBadge">Chapter 1</div>
            </div>

            <div class="question-text" id="questionText">
                문제를 불러오는 중...
            </div>

            <div class="options-container" id="optionsContainer">
                <!-- 선택지들이 동적으로 생성됩니다 -->
            </div>
        </div>

        <!-- 네비게이션 -->
        <div class="navigation">
            <button class="nav-btn prev" id="prevBtn" onclick="previousQuestion()" disabled>
                ⬅️ 이전
            </button>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <button class="nav-btn next" id="nextBtn" onclick="nextQuestion()">
                다음 ➡️
            </button>
        </div>
    </div>

    <!-- 챕터 결과 모달 -->
    <div class="chapter-result-modal" id="chapterResultModal">
        <div class="chapter-result-content">
            <div class="chapter-result-header">
                <div class="chapter-result-title" id="chapterResultTitle">Chapter 1 완료!</div>
                <div class="chapter-score" id="chapterScoreText">8/10 (80%)</div>
            </div>

            <div class="questions-review" id="questionsReview">
                <!-- 문제별 정답/오답이 동적으로 생성됩니다 -->
            </div>

            <button class="continue-btn" onclick="continueToNextChapter()">
                다음 챕터로 계속 ➡️
            </button>
        </div>
    </div>

    <!-- 최종 결과 모달 -->
    <div class="final-result-modal" id="finalResultModal">
        <div class="final-result-content">
            <div class="final-result-title">🎉 퀴즈 완료!</div>
            <div class="final-score" id="finalScore">85%</div>
            <div class="final-details">
                <div class="chapter-breakdown" id="chapterBreakdown">
                    <!-- 챕터별 점수가 동적으로 생성됩니다 -->
                </div>
                <div>총 문제: <strong>50개</strong></div>
                <div>정답: <strong id="totalCorrect">42개</strong></div>
                <div>소요 시간: <strong id="timeSpent">25분 30초</strong></div>
            </div>
            <button class="result-btn" onclick="restartQuiz()">🔄 다시 풀기</button>
            <button class="result-btn" onclick="goToBooks()">📚 도서 목록</button>
        </div>
    </div>

    <script>
        // ================ 퀴즈 데이터 (챕터별 10문제씩 총 50문제) ================
        const quizData = {
            'MTH001': {
                title: 'Magic Tree House',
                author: 'Mary Pope Osborne',
                timeLimit: 30, // 30분
                questions: [
                    // Chapter 1 (10문제)
                    {
                        chapter: 1,
                        question: "Who are the main characters in Magic Tree House?",
                        options: ["Jack and Jill", "Jack and Annie", "Tom and Annie", "Jack and Sarah"],
                        correct: 1
                    },
                    {
                        chapter: 1,
                        question: "Where do Jack and Annie find the tree house?",
                        options: ["In their backyard", "In Frog Creek woods", "At school", "In the park"],
                        correct: 1
                    },
                    {
                        chapter: 1,
                        question: "What is special about the tree house?",
                        options: ["Very tall", "Magic - travels through time", "Has toys", "Very old"],
                        correct: 1
                    },
                    {
                        chapter: 1,
                        question: "How do Jack and Annie travel in time?",
                        options: ["Close eyes and wish", "Point to picture in book", "Say magic words", "Turn a key"],
                        correct: 1
                    },
                    {
                        chapter: 1,
                        question: "What does Jack always carry with him?",
                        options: ["Backpack", "Notebook and pencil", "Camera", "Map"],
                        correct: 1
                    },
                    {
                        chapter: 1,
                        question: "How is Jack's personality described?",
                        options: ["Brave and reckless", "Careful and likes to read", "Funny and loud", "Quiet and shy"],
                        correct: 1
                    },
                    {
                        chapter: 1,
                        question: "How is Annie's personality described?",
                        options: ["Careful and quiet", "Brave and adventurous", "Scared and nervous", "Smart and serious"],
                        correct: 1
                    },
                    {
                        chapter: 1,
                        question: "What happens when they go on their first adventure?",
                        options: ["Get lost", "Meet dinosaurs", "Find treasure", "Get scared"],
                        correct: 1
                    },
                    {
                        chapter: 1,
                        question: "What time period do they visit first?",
                        options: ["Medieval times", "Dinosaur era", "Ancient Egypt", "Wild West"],
                        correct: 1
                    },
                    {
                        chapter: 1,
                        question: "How do they get back home?",
                        options: ["Walk", "Point to picture of Frog Creek", "Wait for magic", "Call for help"],
                        correct: 1
                    },

                    // Chapter 2 (10문제)
                    {
                        chapter: 2,
                        question: "Where do Jack and Annie go in their second adventure?",
                        options: ["Ancient Egypt", "Medieval castle", "Dinosaur time", "Space"],
                        correct: 1
                    },
                    {
                        chapter: 2,
                        question: "What do they wear in medieval times?",
                        options: ["Modern clothes", "Medieval costumes", "Pajamas", "School uniforms"],
                        correct: 1
                    },
                    {
                        chapter: 2,
                        question: "Who do they meet at the castle?",
                        options: ["King and Queen", "Knights", "Servants", "All of the above"],
                        correct: 3
                    },
                    {
                        chapter: 2,
                        question: "What is happening at the castle?",
                        options: ["Party", "Wedding", "Feast and celebration", "War"],
                        correct: 2
                    },
                    {
                        chapter: 2,
                        question: "What does Annie want to do at the castle?",
                        options: ["Leave immediately", "Explore everything", "Hide", "Find food"],
                        correct: 1
                    },
                    {
                        chapter: 2,
                        question: "What does Jack worry about?",
                        options: ["Getting home", "Getting in trouble", "Getting lost", "All of the above"],
                        correct: 3
                    },
                    {
                        chapter: 2,
                        question: "What do they learn about medieval life?",
                        options: ["Very easy", "Hard and different from today", "Same as today", "Very fun"],
                        correct: 1
                    },
                    {
                        chapter: 2,
                        question: "How do people at the castle treat them?",
                        options: ["Ignore them", "Kindly", "Badly", "With suspicion"],
                        correct: 1
                    },
                    {
                        chapter: 2,
                        question: "What does Jack write about?",
                        options: ["Nothing", "Everything he sees", "Only scary things", "Only fun things"],
                        correct: 1
                    },
                    {
                        chapter: 2,
                        question: "How do they escape danger?",
                        options: ["Run fast", "Hide", "Use the magic tree house", "Fight"],
                        correct: 2
                    },

                    // Chapter 3 (10문제)
                    {
                        chapter: 3,
                        question: "Where do they travel in their third adventure?",
                        options: ["Ancient Egypt", "Wild West", "Jungle", "Ocean"],
                        correct: 0
                    },
                    {
                        chapter: 3,
                        question: "What do they see in ancient Egypt?",
                        options: ["Pyramids", "Pharaohs", "Mummies", "All of the above"],
                        correct: 3
                    },
                    {
                        chapter: 3,
                        question: "Who helps them in Egypt?",
                        options: ["Tourist guide", "Egyptian cat", "Pharaoh", "Archaeologist"],
                        correct: 1
                    },
                    {
                        chapter: 3,
                        question: "What is the cat's name?",
                        options: ["Fluffy", "Kheti", "Mittens", "Shadow"],
                        correct: 1
                    },
                    {
                        chapter: 3,
                        question: "Where does the cat lead them?",
                        options: ["Pyramid", "Palace", "Market", "River"],
                        correct: 0
                    },
                    {
                        chapter: 3,
                        question: "What do they find inside the pyramid?",
                        options: ["Gold", "Mummy", "Treasure room", "Secret passages"],
                        correct: 3
                    },
                    {
                        chapter: 3,
                        question: "What danger do they face?",
                        options: ["Wild animals", "Getting lost in pyramid", "Angry people", "Sandstorm"],
                        correct: 1
                    },
                    {
                        chapter: 3,
                        question: "How does the cat help them?",
                        options: ["Shows them the way", "Protects them", "Brings food", "Calls for help"],
                        correct: 0
                    },
                    {
                        chapter: 3,
                        question: "What do they learn about ancient Egypt?",
                        options: ["Building pyramids", "Mummification", "Egyptian culture", "All of the above"],
                        correct: 3
                    },
                    {
                        chapter: 3,
                        question: "How do they escape the pyramid?",
                        options: ["Follow the cat", "Use magic", "Dig tunnel", "Call for help"],
                        correct: 0
                    },

                    // Chapter 4 (10문제)
                    {
                        chapter: 4,
                        question: "What new place do they visit?",
                        options: ["Pirates' ship", "Amazon rainforest", "Space station", "Underwater"],
                        correct: 1
                    },
                    {
                        chapter: 4,
                        question: "What animals do they meet in the rainforest?",
                        options: ["Monkeys", "Birds", "Insects", "All of the above"],
                        correct: 3
                    },
                    {
                        chapter: 4,
                        question: "What is their mission in the rainforest?",
                        options: ["Find treasure", "Help scientist", "Rescue animals", "Find magical flower"],
                        correct: 1
                    },
                    {
                        chapter: 4,
                        question: "Who do they meet in the rainforest?",
                        options: ["Explorer", "Scientist", "Native people", "All of the above"],
                        correct: 3
                    },
                    {
                        chapter: 4,
                        question: "What danger threatens the rainforest?",
                        options: ["Fire", "Cutting down trees", "Pollution", "All of the above"],
                        correct: 3
                    },
                    {
                        chapter: 4,
                        question: "How do the animals communicate?",
                        options: ["Words", "Sounds and signals", "Writing", "Telepathy"],
                        correct: 1
                    },
                    {
                        chapter: 4,
                        question: "What does Annie discover about animals?",
                        options: ["They're scary", "They're friendly and intelligent", "They're dangerous", "They're boring"],
                        correct: 1
                    },
                    {
                        chapter: 4,
                        question: "What does Jack learn about ecosystems?",
                        options: ["Nothing important", "Everything is connected", "Only about trees", "Only about animals"],
                        correct: 1
                    },
                    {
                        chapter: 4,
                        question: "How do they help in the rainforest?",
                        options: ["Plant trees", "Save animals", "Spread awareness", "All of the above"],
                        correct: 3
                    },
                    {
                        chapter: 4,
                        question: "What important lesson do they learn?",
                        options: ["Nature needs protection", "Adventure is fun", "Animals are scary", "Trees are tall"],
                        correct: 0
                    },

                    // Chapter 5 (10문제)
                    {
                        chapter: 5,
                        question: "Where is their final adventure in this book?",
                        options: ["Titanic", "Moon", "Wild West", "Ancient China"],
                        correct: 0
                    },
                    {
                        chapter: 5,
                        question: "What is special about the Titanic adventure?",
                        options: ["Very dangerous", "Historical disaster", "Many people", "All of the above"],
                        correct: 3
                    },
                    {
                        chapter: 5,
                        question: "Who do they meet on the Titanic?",
                        options: ["Captain", "Passengers", "Crew members", "All of the above"],
                        correct: 3
                    },
                    {
                        chapter: 5,
                        question: "What do they know will happen to the ship?",
                        options: ["Nothing", "Will sink", "Will get lost", "Will be attacked"],
                        correct: 1
                    },
                    {
                        chapter: 5,
                        question: "How do they try to help?",
                        options: ["Warn people", "Help with lifeboats", "Stay calm", "All of the above"],
                        correct: 3
                    },
                    {
                        chapter: 5,
                        question: "What do they learn about courage?",
                        options: ["Only adults are brave", "Anyone can be brave", "Courage is scary", "Courage is easy"],
                        correct: 1
                    },
                    {
                        chapter: 5,
                        question: "How do people on the ship behave?",
                        options: ["All panic", "Some brave, some scared", "Everyone calm", "Everyone fights"],
                        correct: 1
                    },
                    {
                        chapter: 5,
                        question: "What do Jack and Annie do to help?",
                        options: ["Nothing", "Help children", "Cause trouble", "Hide"],
                        correct: 1
                    },
                    {
                        chapter: 5,
                        question: "How do they escape the sinking ship?",
                        options: ["Lifeboat", "Magic tree house appears", "Swimming", "Helicopter"],
                        correct: 1
                    },
                    {
                        chapter: 5,
                        question: "What is the main theme of Magic Tree House?",
                        options: ["Magic is real", "Learning through adventure", "Siblings fighting", "School is important"],
                        correct: 1
                    }
                ]
            }
        };

        // ================ 퀴즈 상태 변수 ================
        let currentBookId = '';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let chapterScores = []; // 챕터별 점수
        let startTime = Date.now();
        let timeRemaining = 0;
        let timerInterval = null;

        // ================ 초기화 함수 ================
        function initQuiz() {
            // URL에서 책 ID 추출
            const urlParams = new URLSearchParams(window.location.search);
            currentBookId = urlParams.get('book') || 'MTH001';
            
            console.log('퀴즈 초기화:', currentBookId);
            
            // 퀴즈 데이터 로드
            const bookData = quizData[currentBookId];
            if (!bookData) {
                alert('퀴즈 데이터를 찾을 수 없습니다.');
                return;
            }
            
            currentQuestions = bookData.questions;
            userAnswers = new Array(currentQuestions.length);
            chapterScores = new Array(5).fill(0); // 5개 챕터
            timeRemaining = bookData.timeLimit * 60; // 분을 초로 변환
            
            // UI 초기화
            document.getElementById('bookTitle').textContent = bookData.title + ' Quiz';
            updateProgress();
            startTimer();
            showQuestion(0);
            
            console.log(`퀴즈 시작: ${currentQuestions.length}문제, ${bookData.timeLimit}분`);
        }

        // ================ 타이머 함수 ================
        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    finishQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // ================ 문제 표시 함수 ================
        function showQuestion(index) {
            if (index < 0 || index >= currentQuestions.length) return;
            
            currentQuestionIndex = index;
            const question = currentQuestions[index];
            
            // 문제 정보 업데이트
            document.getElementById('questionNumber').textContent = `문제 ${index + 1}`;
            document.getElementById('chapterBadge').textContent = `Chapter ${question.chapter}`;
            document.getElementById('questionText').textContent = question.question;
            
            // 선택지 생성
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            question.options.forEach((option, optIndex) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.onclick = () => selectOption(optIndex);
                
                optionDiv.innerHTML = `
                    <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                    <div class="option-text">${option}</div>
                `;
                
                container.appendChild(optionDiv);
            });
            
            // 진행률 업데이트
            updateProgress();
            updateNavigation();
            
            // 이전 답변 복원
            if (userAnswers[index] !== undefined) {
                selectOption(userAnswers[index], false);
            }
        }

        // ================ 선택지 선택 함수 ================
        function selectOption(optionIndex, save = true) {
            // 이전 선택 해제
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // 새 선택 적용
            const options = document.querySelectorAll('.option');
            if (options[optionIndex]) {
                options[optionIndex].classList.add('selected');
            }
            
            // 답변 저장
            if (save) {
                userAnswers[currentQuestionIndex] = optionIndex;
                updateProgress();
            }
        }

        // ================ 진행률 업데이트 ================
        function updateProgress() {
            const answered = userAnswers.filter(answer => answer !== undefined).length;
            const total = currentQuestions.length;
            const percentage = (currentQuestionIndex + 1) / total * 100;
            
            document.getElementById('progressInfo').textContent = 
                `문제 ${currentQuestionIndex + 1}/${total} (답변완료: ${answered})`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            
            // 현재 챕터 점수 표시
            const currentChapter = currentQuestions[currentQuestionIndex].chapter;
            const chapterQuestions = currentQuestions.filter(q => q.chapter === currentChapter);
            const chapterAnswered = chapterQuestions.filter((q, i) => {
                const questionIndex = currentQuestions.findIndex(question => question === q);
                return userAnswers[questionIndex] !== undefined;
            }).length;
            
            document.getElementById('chapterScoreDisplay').textContent = 
                `Chapter ${currentChapter}: ${chapterAnswered}/${chapterQuestions.length}`;
            document.getElementById('chapterScoreDisplay').style.display = 'block';
        }

        // ================ 네비게이션 업데이트 ================
        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentQuestionIndex === 0;
            
            // 챕터의 마지막 문제인지 확인
            const currentChapter = currentQuestions[currentQuestionIndex].chapter;
            const isLastQuestionOfChapter = (currentQuestionIndex === currentQuestions.length - 1) || 
                (currentQuestionIndex < currentQuestions.length - 1 && 
                 currentQuestions[currentQuestionIndex + 1].chapter !== currentChapter);
            
            if (currentQuestionIndex === currentQuestions.length - 1) {
                nextBtn.textContent = '🏁 최종 완료';
                nextBtn.className = 'nav-btn finish';
            } else if (isLastQuestionOfChapter) {
                nextBtn.textContent = `📊 Chapter ${currentChapter} 완료`;
                nextBtn.className = 'nav-btn chapter-finish';
            } else {
                nextBtn.textContent = '다음 ➡️';
                nextBtn.className = 'nav-btn next';
            }
        }

        // ================ 네비게이션 함수들 ================
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        }

        function nextQuestion() {
            const currentChapter = currentQuestions[currentQuestionIndex].chapter;
            const isLastQuestionOfChapter = (currentQuestionIndex === currentQuestions.length - 1) || 
                (currentQuestionIndex < currentQuestions.length - 1 && 
                 currentQuestions[currentQuestionIndex + 1].chapter !== currentChapter);
            
            if (currentQuestionIndex === currentQuestions.length - 1) {
                // 마지막 문제
                finishQuiz();
            } else if (isLastQuestionOfChapter) {
                // 챕터 마지막 문제
                showChapterResult(currentChapter);
            } else {
                // 일반적인 다음 문제
                showQuestion(currentQuestionIndex + 1);
            }
        }

        // ================ 챕터 결과 표시 ================
        function showChapterResult(chapter) {
            // 챕터별 문제들 필터링
            const chapterQuestions = currentQuestions.filter((q, index) => {
                return q.chapter === chapter && index <= currentQuestionIndex;
            });
            
            // 챕터별 정답 계산
            let correctCount = 0;
            const reviewItems = [];
            
            chapterQuestions.forEach((question, chapterIndex) => {
                const questionIndex = currentQuestions.findIndex(q => q === question);
                const userAnswer = userAnswers[questionIndex];
                const isCorrect = userAnswer === question.correct;
                
                if (isCorrect) correctCount++;
                
                reviewItems.push({
                    question: question.question,
                    userAnswer: userAnswer,
                    correctAnswer: question.correct,
                    options: question.options,
                    isCorrect: isCorrect
                });
            });
            
            chapterScores[chapter - 1] = correctCount;
            
            // 결과 모달 내용 설정
            document.getElementById('chapterResultTitle').textContent = `Chapter ${chapter} 완료!`;
            document.getElementById('chapterScoreText').textContent = 
                `${correctCount}/${chapterQuestions.length} (${Math.round(correctCount / chapterQuestions.length * 100)}%)`;
            
            // 문제별 리뷰 생성
            const reviewContainer = document.getElementById('questionsReview');
            reviewContainer.innerHTML = '';
            
            reviewItems.forEach((item, index) => {
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `question-review-item ${item.isCorrect ? 'correct' : 'wrong'}`;
                
                const userAnswerText = item.userAnswer !== undefined ? item.options[item.userAnswer] : '미답변';
                const correctAnswerText = item.options[item.correctAnswer];
                
                reviewDiv.innerHTML = `
                    <div class="review-question">Q${index + 1}. ${item.question}</div>
                    <div class="review-answers">
                        <div class="your-answer">선택한 답: ${userAnswerText}</div>
                        ${!item.isCorrect ? `<div class="correct-answer">정답: ${correctAnswerText}</div>` : ''}
                    </div>
                `;
                
                reviewContainer.appendChild(reviewDiv);
            });
            
            // 모달 표시
            document.getElementById('chapterResultModal').classList.add('show');
        }

        // ================ 다음 챕터로 계속 ================
        function continueToNextChapter() {
            document.getElementById('chapterResultModal').classList.remove('show');
            
            if (currentQuestionIndex < currentQuestions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            } else {
                finishQuiz();
            }
        }

        // ================ 퀴즈 완료 함수 ================
        function finishQuiz() {
            clearInterval(timerInterval);
            
            // 마지막 챕터 점수 계산 (아직 계산되지 않았다면)
            const lastChapter = currentQuestions[currentQuestions.length - 1].chapter;
            if (chapterScores[lastChapter - 1] === 0) {
                const lastChapterQuestions = currentQuestions.filter(q => q.chapter === lastChapter);
                let correctCount = 0;
                lastChapterQuestions.forEach(question => {
                    const questionIndex = currentQuestions.findIndex(q => q === question);
                    if (userAnswers[questionIndex] === question.correct) {
                        correctCount++;
                    }
                });
                chapterScores[lastChapter - 1] = correctCount;
            }
            
            // 전체 결과 계산
            const totalCorrect = chapterScores.reduce((sum, score) => sum + score, 0);
            const percentage = Math.round((totalCorrect / currentQuestions.length) * 100);
            const timeSpent = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;
            
            // 챕터별 점수 표시
            const breakdownContainer = document.getElementById('chapterBreakdown');
            breakdownContainer.innerHTML = '';
            
            chapterScores.forEach((score, index) => {
                const chapter = index + 1;
                const chapterTotal = currentQuestions.filter(q => q.chapter === chapter).length;
                const chapterPercentage = Math.round((score / chapterTotal) * 100);
                
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'chapter-score-item';
                scoreDiv.innerHTML = `
                    <div style="font-weight: 600; color: #667eea;">Ch.${chapter}</div>
                    <div style="font-size: 0.9rem;">${score}/${chapterTotal}</div>
                    <div style="font-size: 0.8rem; color: #666;">${chapterPercentage}%</div>
                `;
                
                breakdownContainer.appendChild(scoreDiv);
            });
            
            // 결과 표시
            document.getElementById('finalScore').textContent = `${percentage}%`;
            document.getElementById('totalCorrect').textContent = `${totalCorrect}개`;
            document.getElementById('timeSpent').textContent = `${minutes}분 ${seconds}초`;
            
            document.getElementById('finalResultModal').classList.add('show');
        }

        // ================ 기타 함수들 ================
        function restartQuiz() {
            document.getElementById('finalResultModal').classList.remove('show');
            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuestions.length);
            chapterScores = new Array(5).fill(0);
            startTime = Date.now();
            
            const bookData = quizData[currentBookId];
            timeRemaining = bookData.timeLimit * 60;
            
            clearInterval(timerInterval);
            startTimer();
            showQuestion(0);
        }

        function goToBooks() {
            window.location.href = 'books.html';
        }

        // ================ 키보드 이벤트 ================
        document.addEventListener('keydown', function(e) {
            // 모달이 열려있으면 키보드 이벤트 무시
            if (document.getElementById('chapterResultModal').classList.contains('show') ||
                document.getElementById('finalResultModal').classList.contains('show')) {
                return;
            }
            
            // 숫자 키로 선택지 선택 (1-4)
            const num = parseInt(e.key);
            if (num >= 1 && num <= 4) {
                selectOption(num - 1);
            }
            
            // 화살표 키로 네비게이션
            if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight') {
                nextQuestion();
            }
        });

        // ================ 페이지 로드 시 초기화 ================
        window.addEventListener('load', initQuiz);
        
        // 페이지 나가기 방지
        window.addEventListener('beforeunload', function(e) {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>
