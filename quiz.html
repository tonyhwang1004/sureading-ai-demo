<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìù AI Î¨∏Ï†ú ÌíÄÏù¥ - Sue Reading Academy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding-top: 60px;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        .quiz-header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .academy-brand {
            font-size: 1.8rem;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .book-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .book-cover {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .book-details h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: #333;
        }
        
        .book-details p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .progress-section {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .progress-bar {
            background: #e0e0e0;
            border-radius: 25px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .progress-fill {
            background: linear-gradient(45deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 25px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }
        
        .quiz-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }
        
        .question-type {
            position: absolute;
            top: 15px;
            right: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .question {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 30px;
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .options {
            display: grid;
            gap: 15px;
        }
        
        .option {
            padding: 20px 25px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f8f9fa;
            position: relative;
            overflow: hidden;
        }
        
        .option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }
        
        .option:hover {
            border-color: #667eea;
            background: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
        }
        
        .option:hover::before {
            left: 100%;
        }
        
        .option.selected {
            border-color: #667eea;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .option.correct {
            border-color: #28a745;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            animation: correctPulse 0.6s ease-in-out;
        }
        
        .option.incorrect {
            border-color: #dc3545;
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            animation: incorrectShake 0.6s ease-in-out;
        }
        
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .option-letter {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 15px;
            font-size: 0.9rem;
        }
        
        .option.selected .option-letter,
        .option.correct .option-letter,
        .option.incorrect .option-letter {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .explanation {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-left: 5px solid #667eea;
            padding: 25px;
            margin-top: 25px;
            border-radius: 0 15px 15px 0;
            display: none;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .explanation-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .question-info {
            font-weight: bold;
            color: #666;
            font-size: 1.1rem;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: width 0.3s, height 0.3s;
            transform: translate(-50%, -50%);
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn-success { 
            background: linear-gradient(45deg, #28a745, #20c997); 
            color: white; 
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .btn-secondary { 
            background: linear-gradient(45deg, #6c757d, #495057); 
            color: white; 
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        .btn-warning { 
            background: linear-gradient(45deg, #ffc107, #fd7e14); 
            color: #212529; 
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        
        .btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .score-display {
            font-size: 4rem;
            margin: 30px 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .result-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }
        
        .result-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .result-label {
            color: #666;
            margin-top: 5px;
        }
        
        .back-button {
            position: fixed;
            top: 80px;
            left: 20px;
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
            text-decoration: none;
            color: white;
        }
        
        .loading-animation {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .quiz-header, .quiz-card { padding: 25px; }
            .book-info { flex-direction: column; text-align: center; }
            .controls { flex-direction: column; align-items: stretch; }
            .btn-group { justify-content: center; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .back-button { position: relative; top: auto; left: auto; margin-bottom: 20px; }
        }
    </style>
</head>
<body>
    <a href="books.html" class="back-button">‚Üê üìö ÎèÑÏÑú Î™©Î°ù</a>
    
    <div class="container">
        <div class="quiz-header">
            <div class="academy-brand">üè´ Sue Reading Academy</div>
            <div class="book-info" id="book-info">
                <div class="loading-animation">
                    <div class="spinner"></div>
                    <p>AI Î¨∏Ï†ú ÏãúÏä§ÌÖú Î°úÎî© Ï§ë...</p>
                </div>
            </div>
            
            <div class="progress-section" id="progress-section" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div id="progress-text">Î¨∏Ï†ú Ï§ÄÎπÑ Ï§ë...</div>
                
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="current-question">1</div>
                        <div class="stat-label">ÌòÑÏû¨ Î¨∏Ï†ú</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-questions">10</div>
                        <div class="stat-label">Ï†ÑÏ≤¥ Î¨∏Ï†ú</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="correct-count">0</div>
                        <div class="stat-label">Ï†ïÎãµ Ïàò</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="time-spent">0:00</div>
                        <div class="stat-label">ÏÜåÏöî ÏãúÍ∞Ñ</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="quiz-card" id="quiz-card" style="display: none;">
            <div class="question-type" id="question-type">Ïñ¥Ìúò Ïù¥Ìï¥</div>
            <div class="question" id="question-text"></div>
            
            <div class="options" id="options-container">
                <!-- ÏÑ†ÌÉùÏßÄÎì§ÏùÄ JavaScriptÎ°ú ÏÉùÏÑ± -->
            </div>
            
            <div class="explanation" id="explanation">
                <!-- Ìï¥ÏÑ§ÏùÄ Ï†ïÎãµ ÌõÑ ÌëúÏãú -->
            </div>
            
            <div class="controls">
                <div class="question-info" id="question-info">Î¨∏Ï†ú 1 / 10</div>
                
                <div class="btn-group">
                    <button class="btn btn-warning" id="hint-btn" onclick="showHint()">üí° ÌûåÌä∏</button>
                    <button class="btn btn-primary" id="check-btn" onclick="checkAnswer()" disabled>‚úÖ Ï†ïÎãµ ÌôïÏù∏</button>
                    <button class="btn btn-success" id="next-btn" onclick="nextQuestion()" style="display: none;">‚û°Ô∏è Îã§Ïùå Î¨∏Ï†ú</button>
                </div>
            </div>
        </div>
        
        <div class="result-card" id="result-card">
            <h2>üéâ Sue Reading Academy ÌïôÏäµ ÏôÑÎ£å!</h2>
            <div class="score-display" id="final-score">95%</div>
            
            <div class="result-details" id="result-details">
                <!-- ÏÉÅÏÑ∏ Í≤∞Í≥ºÎäî JavaScriptÎ°ú ÏÉùÏÑ± -->
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="restartQuiz()">üîÑ Îã§Ïãú ÌíÄÍ∏∞</button>
                <button class="btn btn-success" onclick="tryDifferentBook()">üìö Îã§Î•∏ Ï±Ö ÏÑ†ÌÉù</button>
                <a href="books.html" class="btn btn-secondary" style="text-decoration: none; display: inline-block; margin-left: 10px;">üè† ÎèÑÏÑú Î™©Î°ù</a>
            </div>
        </div>
    </div>

    <!-- Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú -->
    <script src="static/js/books-bundle.js"></script>
    <script src="static/js/user-manager.js"></script>
    
    <script>
        let currentBook = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let selectedOption = null;
        let startTime = new Date();
        let questionStartTime = new Date();
        let correctCount = 0;
        let timeInterval = null;

        // URLÏóêÏÑú Ï±Ö ID Í∞ÄÏ†∏Ïò§Í∏∞
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('book') || 'PP001';

        // Î¨∏Ï†ú Ïú†Ìòï ÌïúÍµ≠Ïñ¥ Îß§Ìïë
        const questionTypeMap = {
            'vocabulary': 'Ïñ¥Ìúò Ïù¥Ìï¥',
            'factual': 'ÏÇ¨Ïã§ Ïù¥Ìï¥', 
            'inference': 'Ï∂îÎ°† Ïù¥Ìï¥',
            'critical': 'ÎπÑÌåêÏ†Å ÏÇ¨Í≥†',
            'synthesis': 'Ï¢ÖÌï© Ïù¥Ìï¥'
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Sue Reading Academy ÌîÑÎ¶¨ÎØ∏ÏóÑ ÌÄ¥Ï¶à ÏãúÏûë:', bookId);
            
            // ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù ÌôïÏù∏
            if (!userManager.isLoggedIn()) {
                alert('‚ö†Ô∏è Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                window.location.href = 'login.html';
                return;
            }
            
            // ÏãúÍ∞Ñ ÌëúÏãú ÏãúÏûë
            startTimeCounter();
            
            if (typeof window.SUREADING_DATA !== 'undefined') {
                loadQuiz(bookId);
            } else {
                setTimeout(() => {
                    if (typeof window.SUREADING_DATA !== 'undefined') {
                        loadQuiz(bookId);
                    } else {
                        showLoadingError();
                    }
                }, 3000);
            }
        });

        function loadQuiz(bookId) {
            console.log('üìñ ÌîÑÎ¶¨ÎØ∏ÏóÑ ÌÄ¥Ï¶à Î°úÎî©:', bookId);
            
            // Ï±Ö Ï†ïÎ≥¥ Ï∞æÍ∏∞
            const books = Object.values(window.SUREADING_DATA.books).flat();
            currentBook = books.find(book => book.id === bookId);
            
            if (!currentBook) {
                currentBook = createDefaultBook(bookId);
            }

            // Î¨∏Ï†ú Îç∞Ïù¥ÌÑ∞ Ï∞æÍ∏∞ - Ïö∞ÏÑ†ÏàúÏúÑ: Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ > Í≥†ÌíàÏßà Í∏∞Î≥∏ Î¨∏Ï†ú
            const questionsData = window.SUREADING_DATA.questions[bookId];
            
            if (questionsData && questionsData.chapters) {
                // Ïã§Ï†ú AI Î¨∏Ï†ú ÏÇ¨Ïö©
                currentQuestions = [];
                Object.values(questionsData.chapters).forEach(chapter => {
                    if (chapter.questions) {
                        currentQuestions.push(...chapter.questions);
                    }
                });
                console.log(`‚úÖ Ïã§Ï†ú AI Î¨∏Ï†ú ${currentQuestions.length}Í∞ú Î°úÎìúÎê®`);
            }
            
            // Î¨∏Ï†úÍ∞Ä Î∂ÄÏ°±ÌïòÎ©¥ Í≥†ÌíàÏßà Í∏∞Î≥∏ Î¨∏Ï†úÎ°ú Î≥¥Ï∂©
            if (currentQuestions.length < 10) {
                const additionalQuestions = createAdvancedQuestions(bookId);
                currentQuestions.push(...additionalQuestions);
                console.log(`üìö Í≥†ÌíàÏßà Í∏∞Î≥∏ Î¨∏Ï†ú ${additionalQuestions.length}Í∞ú Ï∂îÍ∞ÄÎê®`);
            }

            // Î¨∏Ï†ú ÏÑûÍ∏∞ Î∞è ÏÑ†ÌÉù
            currentQuestions = shuffleArray(currentQuestions).slice(0, 15);
            
            console.log(`üéØ Ï¥ù ${currentQuestions.length}Í∞ú Î¨∏Ï†úÎ°ú ÌÄ¥Ï¶à ÏãúÏûë`);
            
            // ÏãúÏûë ÏãúÍ∞Ñ Í∏∞Î°ù
            startTime = new Date();
            questionStartTime = new Date();
            
            // UI Ï¥àÍ∏∞Ìôî
            displayBookInfo();
            showQuestion();
        }

        function createDefaultBook(bookId) {
            const bookInfoMap = {
                'PP001': { id: 'PP001', title: 'Peppa Pig', author: 'Ladybird', cover: 'üê∑', coverColor: '#FF6B6B', level: 'Level 1' },
                'FT001': { id: 'FT001', title: 'Frog and Toad Are Friends', author: 'Arnold Lobel', cover: 'üê∏', coverColor: '#4ECDC4', level: 'Level 2' },
                'HM001': { id: 'HM001', title: 'Henry and Mudge', author: 'Cynthia Rylant', cover: 'üêï', coverColor: '#45B7D1', level: 'Level 2' },
                'EP001': { id: 'EP001', title: 'Elephant and Piggie', author: 'Mo Willems', cover: 'üêò', coverColor: '#96CEB4', level: 'Level 2' },
                'CA001': { id: 'CA001', title: 'Charlotte\'s Web', author: 'E.B. White', cover: 'üï∑Ô∏è', coverColor: '#FECA57', level: 'Level 3' },
                'LR001': { id: 'LR001', title: 'Lord of the Rings', author: 'J.R.R. Tolkien', cover: 'üíç', coverColor: '#FF9FF3', level: 'Level 5' }
            };
            
            return bookInfoMap[bookId] || { id: bookId, title: 'Unknown Book', author: 'Sue Reading Academy', cover: 'üìö', coverColor: '#667eea', level: 'Level 1' };
        }

        function createAdvancedQuestions(bookId) {
            const advancedQuestions = {
                'PP001': [
                    {
                        question: "In Peppa Pig stories, what important lesson about family relationships is consistently demonstrated?",
                        options: [
                            "Family members should compete with each other",
                            "Parents and children can learn from each other",
                            "Older siblings should always be in charge",
                            "Family activities are less important than individual pursuits"
                        ],
                        answer: 1,
                        explanation: "Throughout the Peppa Pig series, we see how family members support, learn from, and enjoy time with each other. The stories show that healthy family relationships involve mutual respect, shared activities, and learning together.",
                        type: "synthesis"
                    },
                    {
                        question: "What can young readers infer about problem-solving from how Peppa and her friends handle conflicts?",
                        options: [
                            "Problems should be avoided whenever possible",
                            "Adults should always solve children's problems",
                            "Talking and cooperation help resolve disagreements",
                            "The loudest person usually gets their way"
                        ],
                        answer: 2,
                        explanation: "Peppa Pig episodes consistently show characters working together, discussing their feelings, and finding fair solutions to problems. This teaches children valuable conflict resolution skills.",
                        type: "critical"
                    },
                    {
                        question: "How does the vocabulary in Peppa Pig stories help beginning English learners?",
                        options: [
                            "It uses only very advanced words",
                            "It repeats key words in different contexts",
                            "It avoids using any common words",
                            "It focuses only on formal language"
                        ],
                        answer: 1,
                        explanation: "The series strategically repeats important vocabulary in various situations, helping young learners understand and remember new words through context and repetition.",
                        type: "vocabulary"
                    }
                ],
                'FT001': [
                    {
                        question: "What deeper meaning about friendship can be understood from Frog and Toad's different personalities?",
                        options: [
                            "Friends must have identical interests and behaviors",
                            "Differences in personality can strengthen friendships",
                            "One friend should always change to match the other",
                            "Personality differences always cause problems"
                        ],
                        answer: 1,
                        explanation: "Arnold Lobel masterfully shows how Frog's optimism and Toad's cautiousness complement each other. Their different perspectives help them solve problems and support each other in unique ways.",
                        type: "synthesis"
                    },
                    {
                        question: "What can readers infer about emotional intelligence from how Frog responds to Toad's worries?",
                        options: [
                            "He dismisses Toad's feelings as unimportant",
                            "He shows empathy and offers thoughtful support",
                            "He tells Toad to handle problems alone",
                            "He changes the subject to avoid difficulties"
                        ],
                        answer: 1,
                        explanation: "Frog consistently demonstrates emotional intelligence by listening to Toad, acknowledging his feelings, and providing comfort and practical help. This models healthy emotional support in relationships.",
                        type: "inference"
                    }
                ],
                'HM001': [
                    {
                        question: "What important life lesson about companionship is demonstrated through Henry and Mudge's relationship?",
                        options: [
                            "Pets are just for entertainment and fun",
                            "True companionship involves mutual care and understanding",
                            "Animals cannot form meaningful relationships with humans",
                            "Companionship should only exist between similar beings"
                        ],
                        answer: 1,
                        explanation: "The Henry and Mudge series beautifully illustrates how genuine companionship involves caring for each other's needs, understanding each other's feelings, and providing support through various life experiences.",
                        type: "critical"
                    }
                ]
            };
            
            return advancedQuestions[bookId] || advancedQuestions['PP001'];
        }

        function displayBookInfo() {
            const progress = userManager.getBookProgress(currentBook.id);
            const completedQuestions = progress ? progress.completed : 0;
            
            const bookInfoHtml = `
                <div class="book-cover" style="background: ${currentBook.coverColor};">
                    ${currentBook.cover}
                </div>
                <div class="book-details">
                    <h2>${currentBook.title}</h2>
                    <p>by ${currentBook.author}</p>
                    <p><strong>${currentBook.level}</strong></p>
                    <div style="margin-top: 15px;">
                        <span style="background: linear-gradient(45deg, #28a745, #20c997); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; margin-right: 8px;">
                            üè´ Sue Reading Academy
                        </span>
                        <span style="background: #e3f2fd; color: #1976d2; padding: 5px 12px; border-radius: 15px; font-size: 0.85rem;">
                            üìä Ïù¥Ï†Ñ ÏôÑÎ£å: ${completedQuestions}Î¨∏Ï†ú
                        </span>
                    </div>
                </div>
            `;
            
            document.getElementById('book-info').innerHTML = bookInfoHtml;
            document.getElementById('progress-section').style.display = 'block';
        }

        function showQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            questionStartTime = new Date();
            
            // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').innerHTML = 
                `Î¨∏Ï†ú ${currentQuestionIndex + 1} / ${currentQuestions.length} (${Math.round(progress)}% ÏôÑÎ£å)`;
            
            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('current-question').textContent = currentQuestionIndex + 1;
            document.getElementById('total-questions').textContent = currentQuestions.length;
            document.getElementById('correct-count').textContent = correctCount;
            
            // Î¨∏Ï†ú Ïú†Ìòï ÌëúÏãú
            const questionType = questionTypeMap[question.type] || 'Ï¢ÖÌï© Ïù¥Ìï¥';
            document.getElementById('question-type').textContent = questionType;
            
            // Î¨∏Ï†ú ÌëúÏãú
            document.getElementById('question-text').innerHTML = question.question;
            document.getElementById('question-info').innerHTML = 
                `Î¨∏Ï†ú ${currentQuestionIndex + 1} / ${currentQuestions.length} - ${questionType}`;
            
            // ÏÑ†ÌÉùÏßÄ ÏÉùÏÑ±
            const optionsHtml = question.options.map((option, index) => `
                <div class="option" onclick="selectOption(${index})" data-index="${index}">
                    <span class="option-letter">${String.fromCharCode(65 + index)}</span>
                    ${option}
                </div>
            `).join('');
            
            document.getElementById('options-container').innerHTML = optionsHtml;
            
            // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            selectedOption = null;
            document.getElementById('check-btn').disabled = true;
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('explanation').style.display = 'none';
            
            // ÌÄ¥Ï¶à Ïπ¥Îìú ÌëúÏãú
            document.getElementById('quiz-card').style.display = 'block';
        }

        function selectOption(index) {
            // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // ÏÉà ÏÑ†ÌÉù Ï†ÅÏö©
            document.querySelector(`[data-index="${index}"]`).classList.add('selected');
            selectedOption = index;
            
            // Ï†ïÎãµ ÌôïÏù∏ Î≤ÑÌäº ÌôúÏÑ±Ìôî
            document.getElementById('check-btn').disabled = false;
        }

        function checkAnswer() {
            const question = currentQuestions[currentQuestionIndex];
            const isCorrect = selectedOption === question.answer;
            const timeSpent = new Date() - questionStartTime;
            
            if (isCorrect) {
                correctCount++;
                document.getElementById('correct-count').textContent = correctCount;
            }
            
            // ÏÇ¨Ïö©Ïûê Îãµ Ï†ÄÏû•
            userAnswers.push({
                question: question.question,
                userAnswer: selectedOption,
                correctAnswer: question.answer,
                isCorrect: isCorrect,
                score: isCorrect ? 100 : 0,
                timeSpent: timeSpent,
                questionType: question.type
            });
            
            // ÏßÑÎèÑ Ï†ÄÏû• (Sue Reading Academy ÏãúÏä§ÌÖú)
            userManager.saveProgress(currentBook.id, currentQuestionIndex, isCorrect ? 100 : 0, isCorrect);
            
            // Í≤∞Í≥º ÌëúÏãú
            document.querySelectorAll('.option').forEach((opt, index) => {
                opt.onclick = null; // ÌÅ¥Î¶≠ ÎπÑÌôúÏÑ±Ìôî
                
                if (index === question.answer) {
                    opt.classList.add('correct');
                } else if (index === selectedOption && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });
            
            // Ìï¥ÏÑ§ ÌëúÏãú
            const explanationTitle = isCorrect ? '‚úÖ Ï†ïÎãµÏûÖÎãàÎã§!' : '‚ùå ÏïÑÏâΩÎÑ§Ïöî!';
            document.getElementById('explanation').innerHTML = `
                <div class="explanation-title">${explanationTitle}</div>
                <p>${question.explanation}</p>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; font-size: 0.9rem; color: #666;">
                    <strong>üí° ÌïôÏäµ ÌåÅ:</strong> Ïù¥Îü∞ Ïú†ÌòïÏùò Î¨∏Ï†úÎäî ${getStudyTip(question.type)}
                </div>
                <div style="margin-top: 10px; font-size: 0.85rem; color: #28a745;">
                    üìö Sue Reading AcademyÏóê ÌïôÏäµ Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.
                </div>
            `;
            document.getElementById('explanation').style.display = 'block';
            
            // Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        function getStudyTip(questionType) {
            const tips = {
                'vocabulary': 'Îã®Ïñ¥Ïùò Î¨∏Îß•Í≥º ÏÉÅÌô©ÏùÑ Ïù¥Ìï¥ÌïòÎäî Í≤ÉÏù¥ Ï§ëÏöîÌï©ÎãàÎã§.',
                'factual': 'Î≥∏Î¨∏Ïùò Ï†ïÌôïÌïú Ï†ïÎ≥¥Î•º Ï∞æÏïÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.',
                'inference': 'Ï£ºÏñ¥ÏßÑ Ï†ïÎ≥¥Î•º Î∞îÌÉïÏúºÎ°ú ÎÖºÎ¶¨Ï†ÅÏúºÎ°ú Ï∂îÎ°†Ìï¥Î≥¥ÏÑ∏Ïöî.',
                'critical': 'ÏûëÍ∞ÄÏùò ÏùòÎèÑÏôÄ Î©îÏãúÏßÄÎ•º ÍπäÏù¥ ÏÉùÍ∞ÅÌï¥Î≥¥ÏÑ∏Ïöî.',
                'synthesis': 'Ï†ÑÏ≤¥Ï†ÅÏù∏ ÎÇ¥Ïö©ÏùÑ Ï¢ÖÌï©ÌïòÏó¨ Ïù¥Ìï¥ÌïòÏÑ∏Ïöî.'
            };
            return tips[questionType] || 'Ï∞®Í∑ºÏ∞®Í∑º ÏùΩÍ≥† Ïù¥Ìï¥ÌïòÎäî Í≤ÉÏù¥ Ï§ëÏöîÌï©ÎãàÎã§.';
        }

        function nextQuestion() {
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= currentQuestions.length) {
                showResults();
            } else {
                showQuestion();
            }
        }

        function showResults() {
            const totalCount = userAnswers.length;
            const percentage = Math.round((correctCount / totalCount) * 100);
            const totalTime = new Date() - startTime;
            const avgTime = Math.round(totalTime / totalCount / 1000);
            
            // ÏÑ±Ï†Å Îì±Í∏â Í≥ÑÏÇ∞
            let grade, gradeColor, gradeEmoji;
            if (percentage >= 90) { 
                grade = 'ÏµúÏö∞Ïàò'; gradeColor = '#28a745'; gradeEmoji = 'üèÜ';
            } else if (percentage >= 80) { 
                grade = 'Ïö∞Ïàò'; gradeColor = '#20c997'; gradeEmoji = 'üéâ';
            } else if (percentage >= 70) { 
                grade = 'ÏñëÌò∏'; gradeColor = '#ffc107'; gradeEmoji = 'üëç';
            } else if (percentage >= 60) { 
                grade = 'Î≥¥ÌÜµ'; gradeColor = '#fd7e14'; gradeEmoji = 'üìö';
            } else { 
                grade = 'Îçî Ïó∞Ïäµ ÌïÑÏöî'; gradeColor = '#dc3545'; gradeEmoji = 'üí™';
            }
            
            // Î¨∏Ï†ú Ïú†ÌòïÎ≥Ñ Ï†ïÎãµÎ•† Í≥ÑÏÇ∞
            const typeResults = {};
            userAnswers.forEach(answer => {
                if (!typeResults[answer.questionType]) {
                    typeResults[answer.questionType] = { correct: 0, total: 0 };
                }
                typeResults[answer.questionType].total++;
                if (answer.isCorrect) {
                    typeResults[answer.questionType].correct++;
                }
            });
            
            const resultDetailsHtml = `
                <div class="result-item">
                    <div class="result-number">${correctCount}</div>
                    <div class="result-label">Ï†ïÎãµ Ïàò</div>
                </div>
                <div class="result-item">
                    <div class="result-number">${totalCount}</div>
                    <div class="result-label">Ï¥ù Î¨∏Ï†ú</div>
                </div>
                <div class="result-item">
                    <div class="result-number">${avgTime}Ï¥à</div>
                    <div class="result-label">ÌèâÍ∑† ÏãúÍ∞Ñ</div>
                </div>
                <div class="result-item">
                    <div class="result-number" style="color: ${gradeColor};">${gradeEmoji}</div>
                    <div class="result-label">${grade}</div>
                </div>
            `;
            
            document.getElementById('final-score').innerHTML = `${percentage}%`;
            document.getElementById('final-score').style.color = gradeColor;
            document.getElementById('result-details').innerHTML = resultDetailsHtml;
            
            // ÏÉÅÏÑ∏ Î∂ÑÏÑù Ï∂îÍ∞Ä
            let typeAnalysis = '<div style="margin-top: 30px; text-align: left;"><h3>üìä Î¨∏Ï†ú Ïú†ÌòïÎ≥Ñ Î∂ÑÏÑù</h3><div style="margin-top: 15px;">';
            Object.keys(typeResults).forEach(type => {
                const result = typeResults[type];
                const typePercentage = Math.round((result.correct / result.total) * 100);
                const typeName = questionTypeMap[type] || type;
                typeAnalysis += `
                    <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <strong>${typeName}:</strong> ${result.correct}/${result.total} (${typePercentage}%)
                        <div style="width: 100%; background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 5px;">
                            <div style="width: ${typePercentage}%; background: ${gradeColor}; height: 100%; border-radius: 4px;"></div>
                        </div>
                    </div>
                `;
            });
            typeAnalysis += '</div></div>';
            
            document.getElementById('result-details').innerHTML += typeAnalysis;
            
            document.getElementById('quiz-card').style.display = 'none';
            document.getElementById('result-card').style.display = 'block';
            
            // ÏãúÍ∞Ñ Ïπ¥Ïö¥ÌÑ∞ Ï§ëÏßÄ
            if (timeInterval) {
                clearInterval(timeInterval);
            }
        }

        function restartQuiz() {
            if (confirm('üîÑ Í∞ôÏùÄ Ï±ÖÏúºÎ°ú ÏÉàÎ°úÏö¥ Î¨∏Ï†úÎ•º ÌíÄÏñ¥Î≥¥ÏãúÍ≤†ÏäµÎãàÍπå?')) {
                location.reload();
            }
        }

        function tryDifferentBook() {
            if (confirm('üìö Îã§Î•∏ Ï±ÖÏùò Î¨∏Ï†úÎ•º ÌíÄÏñ¥Î≥¥ÏãúÍ≤†ÏäµÎãàÍπå?')) {
                window.location.href = 'books.html';
            }
        }

        function showHint() {
            const question = currentQuestions[currentQuestionIndex];
            const hints = {
                'vocabulary': 'üí° Îã®Ïñ¥Ïùò ÏùòÎØ∏Î•º Î¨∏Îß•ÏúºÎ°ú ÌååÏïÖÌï¥Î≥¥ÏÑ∏Ïöî!',
                'factual': 'üí° Î≥∏Î¨∏ÏóêÏÑú Ï†ïÌôïÌïú Ï†ïÎ≥¥Î•º Ï∞æÏïÑÎ≥¥ÏÑ∏Ïöî!',
                'inference': 'üí° Ï£ºÏñ¥ÏßÑ Ï†ïÎ≥¥Î•º Î∞îÌÉïÏúºÎ°ú Ï∂îÎ°†Ìï¥Î≥¥ÏÑ∏Ïöî!',
                'critical': 'üí° ÏûëÍ∞ÄÏùò ÏùòÎèÑÏôÄ Î©îÏãúÏßÄÎ•º ÏÉùÍ∞ÅÌï¥Î≥¥ÏÑ∏Ïöî!',
                'synthesis': 'üí° Ï†ÑÏ≤¥ ÎÇ¥Ïö©ÏùÑ Ï¢ÖÌï©Ìï¥ÏÑú ÌåêÎã®Ìï¥Î≥¥ÏÑ∏Ïöî!'
            };
            
            const hint = hints[question.type] || 'üí° Î¨∏Ï†úÎ•º Ï∞®Í∑ºÏ∞®Í∑º ÏùΩÏñ¥Î≥¥ÏÑ∏Ïöî!';
            alert(hint + '\n\nüéØ ÏÑ†ÌÉùÏßÄÎ•º Ïã†Ï§ëÌûà ÎπÑÍµêÌï¥Î≥¥ÏÑ∏Ïöî!');
        }

        function startTimeCounter() {
            timeInterval = setInterval(() => {
                const elapsed = Math.floor((new Date() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('time-spent').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function showLoadingError() {
            document.getElementById('book-info').innerHTML = `
                <div style="text-align: center; color: #dc3545;">
                    <h3>‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®</h3>
                    <p>Î¨∏Ï†ú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 15px;">
                        üîÑ Îã§Ïãú ÏãúÎèÑ
                    </button>
                </div>
            `;
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        console.log('‚úÖ Sue Reading Academy ÌîÑÎ¶¨ÎØ∏ÏóÑ ÌÄ¥Ï¶à ÏãúÏä§ÌÖú Î°úÎìú ÏôÑÎ£å');
    </script>
</body>
</html>
